# 在 starry 中使用控制器的改造方案

## 历史版本
1. [第一版](https://github.com/ATS-INTC/moic/blob/5609c8e8a35b7096c7ac53368690cef8390c8e6a/starry-renovation.md)

## 调度模块

1. 将调度模块实现为共享库
2. 重新定义 axtask 模块中的 AxTaskRef，使其能够兼容线程/协程。（这一步是对 starry 进行异步改造，保证可以使用不同方式实现的 Executor）
3. 利用调度模块提供的接口修改 axtask 模块中的 api、processor、schedule 中的实现，使用基于控制器的调度
4. 验证在 unikernel 环境下能否正常工作
5. 重新定义 axprocess 模块中的 Process，与控制器进行兼容。
6. 验证在 monolithic 环境下能否正常工作

## 上下文切换（跳板页的设计）

根据是否切换特权级与地址空间，切换可以分为多种类别，不同类别的切换，出入口不同：

![](./assets/trampoline.svg)

1. 黑色箭头路径：同一个地址空间中的任务主动切换（协程 --> 协程/线程）、同特权级中断（线程 --> 协程/线程）
2. 红色箭头路径：高特权级地址空间主动切换到低特权级空间（协程 --> 不同地址空间的协程/线程）
3. 蓝色箭头路径：系统调用（协程 --> 内核中的协程/线程）、跨特权级中断（线程 --> 高特权级地址空间中的协程/线程）、异常（线程 --> 高特权级地址空间中的协程/线程）

若切换为主动进行，则上一个任务是协程，下一个任务可能为线程或协程。
若切换为被动进行，则上一个任务是线程，下一个任务可能为线程或协程。

## 异步系统调用和异步 IPC 的处理流程

### 异步系统调用

![](./assets/syscall.svg)

### 异步 IPC

![](./assets/ipc.svg)

## 20240702 第二版方案的修改意见

1. 跳板页的设计需要考虑代码简洁、高效的问题，需要设计上下文数据结构
2. 异步系统调用的注册问题：默认环境为异步
3. 异步 IPC 的注册需要内核参与，而不是只通过控制器即可
4. 对 starry 的修改，不应该局限在已有的实现上
